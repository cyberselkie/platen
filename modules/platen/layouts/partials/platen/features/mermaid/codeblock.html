{{- $params     := .                                   -}}
{{- $config     := site.Params.Platen.Features.Mermaid -}}
{{- $aliases    := $config.aliases                     -}}
{{- $page       := $params.Page                        -}}
{{- $position   := $params.Position                    -}}
{{- $definition := $params.Inner                       -}}
{{- $type       := $params.Type | lower                -}}
{{- $attributes := $params.Attributes                  -}}

{{- $renderedCode := "" -}}

{{- $validLanguageIDs := slice "mermaid" -}}
{{- with $aliases -}}
  {{- if (reflect.IsSlice $aliases) -}}
    {{- $validLanguageIDs = union $validLanguageIDs $aliases -}}
  {{- else -}}
    {{- $validLanguageIDs = $validLanguageIDs | append (print $aliases) -}}
  {{- end  -}}
{{- end -}}

{{- if in $validLanguageIDs $type -}}
  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams                       -}}

  {{/* Handle attributes and data */}}
  {{- $caption    := $info.Data.caption                                                 -}}
  {{- $asFigure   := $info.Data.asFigure | default $attributes.asFigure | default false -}}
  {{- $class      := $info.Data.class    | default $attributes.class                    -}}
  {{- $id         := $info.Data.id       | default $attributes.id                       -}}
  {{- $container  := $info.Data.container
                     | default $attributes.container
                     | default $config.container
  -}}

  {{/* Retrieve and trim the actual definition */}}
  {{- $trimParams  := dict "Text" $info.Markdown "TrimEOL" true             -}}
  {{- $mermaidCode := partial "platen/utils/getLeadTrimmedText" $trimParams -}}

  {{- with $caption -}}
    {{- $asFigure = true -}}
  {{- end -}}

  {{/* Ensure Mermaid script gets added to this page */}}
  {{- $params.Page.Store.Set "hasMermaid" true -}}

  {{- $mermaidAttributes  := slice             -}}
  {{- $mermaidClasses     := slice "mermaid"   -}}
  {{- with $class -}}
    {{- $mermaidClasses = $mermaidClasses | append $class -}}
  {{- end -}}

  {{- $mermaidClasses    = delimit $mermaidClasses " "                                       -}}
  {{- $mermaidAttributes = $mermaidAttributes | append (printf `class="%s"` $mermaidClasses) -}}

  {{- if $asFigure -}}
    {{- $figureAttributes := slice                 -}}
    {{- with $id -}}
      {{- $figureAttributes = $figureAttributes | append (printf `id="%s"` $id) -}}
    {{- end -}}
    {{- with $class -}}
      {{- $figureAttributes = $figureAttributes | append (printf `class="%s"` $class) -}}
    {{- end -}}
    {{- $attributeParams := dict "Attributes" $figureAttributes "IndentCount" 8       -}}
    {{- $figureAttributes = partial "platen/utils/getSafeAttributes" $attributeParams -}}
    {{- $renderedCode     = printf "<figure %s>" $figureAttributes                    -}}

    {{- with $caption -}}
      {{- $atTop             := false    -}}
      {{- $text              := $caption -}}
      {{- if reflect.IsMap $caption -}}
        {{- $atTop = default $atTop $caption.AtTop -}}
        {{- $text  = $caption.Text                 -}}
      {{- end -}}

      {{- $indentCount       := add 4 (len $container)                                          -}}
      {{- $mermaidParams     := dict "Attributes" $mermaidAttributes "IndentCount" $indentCount -}}
      {{- $mermaidAttributes := partial "platen/utils/getSafeAttributes" $mermaidParams         -}}
      {{- $mermaidCode       := printf "    %s" (delimit (split $mermaidCode "\n") "\n    ")    -}}
      {{- $mermaidCode       := printf "<%s %s>\n%s\n  </%s>"
                                       $container $mermaidAttributes $mermaidCode $container
      -}}
      {{- $renderParams      := dict "Page"        $page
                                     "Content"     $text
                                     "IndentCount" 4
      -}}
      {{- $renderedcaption := partial "platen/utils/getPrettyRender" $renderParams              -}}
      {{- $captionCode     := printf "  <figcaption>\n    %s\n  </figcaption>" $renderedcaption -}}
      {{- if $atTop -}}
        {{- $renderedCode = printf "%s\n  %s\n%s" $renderedCode $captionCode $mermaidCode -}}
      {{- else -}}
        {{- $renderedCode = printf "%s\n  %s\n%s" $renderedCode $mermaidCode $captionCode -}}
      {{- end -}}
      {{- $renderedCode = printf "%s\n</figure>" $renderedCode -}}
    {{- end -}}
  {{- else -}}
    {{- $attributeParams   := dict "Attributes" $mermaidAttributes "IndentCount" 5          -}}
    {{- $mermaidattributes := partial "platen/utils/getSafeAttributes" $attributeParams     -}}
    {{- $renderedCode       = printf "<pre %s>\n%s\n</pre>" $mermaidattributes $mermaidCode -}}
  {{- end -}}
{{- end -}}

{{- return $renderedCode -}}
