{{- $params     := .                  -}}
{{- $definition := $params.Inner      -}}
{{- $type       := $params.Type       -}}
{{- $attributes := $params.Attributes -}}

{{- $renderedCode := "" -}}

{{- $validLanguageIDs := slice "chem" "katex" "math" -}}
{{- $chemPattern      := `\\ce\{(.|\s)+?\}` -}}

{{- if in $validLanguageIDs (lower $type) -}}
  {{- $params.Page.Store.Set "hasKatex" true -}}
  {{- $chemUsages := findRE $chemPattern $definition   -}}
  {{- $isChemType := eq     "chem"       (lower $type) -}}
  {{- if or $isChemType (gt $chemUsages 0) -}}
    {{- $params.Page.Store.Set "hasChem" true -}}
  {{- end -}}

  {{- $spanAttributes := slice                            -}}
  {{- $classes        := slice                            -}}
  {{- $displayMode    := default true $attributes.display -}}
  {{- with $attributes.class -}}
    {{- $spanAttributes = $spanAttributes | append (printf `class="%s"` $attributes.class) -}}
  {{- end -}}
  {{- $attributeParams := dict "Attributes" $spanAttributes "IndentCount" 6              -}}
  {{- $spanAttributes   = partial "platen/utils/getSafeAttributes" $attributeParams      -}}
  {{- $mungedDefinition := printf "    %s" (delimit (split $definition "\n") "\n    ")   -}}
  {{- if $displayMode -}}
    {{- $renderedCode = printf "\n  \\[\n%s\n  \\]" $mungedDefinition -}}
  {{- else -}}
    {{- $renderedCode = printf "\n  \\(\n%s\n  \\)" $mungedDefinition -}}
  {{- end -}}
  {{- with $spanAttributes -}}
    {{- $renderedCode = printf "<span %s>%s\n</span>" $spanAttributes $renderedCode -}}
  {{- else -}}
    {{- $renderedCode = printf "<span>%s\n</span>" $renderedCode -}}
  {{- end -}}
{{- end -}}

{{- return $renderedCode -}}