{{- $params     := .                                   -}}
{{- $config     := site.Params.Platen.Features.Section -}}
{{- $aliases    := $config.aliases                     -}}
{{- $page       := $params.Page                        -}}
{{- $position   := $params.Position                    -}}
{{- $definition := $params.Inner                       -}}
{{- $type       := $params.Type | lower                -}}
{{- $attributes := $params.Attributes                  -}}

{{- $renderedCode := "" -}}

{{- $validLanguageIDs := slice "section" -}}
{{- with $aliases -}}
  {{- if (reflect.IsSlice $aliases) -}}
    {{- $validLanguageIDs = union $validLanguageIDs $aliases -}}
  {{- else -}}
    {{- $validLanguageIDs = $validLanguageIDs | append (print $aliases) -}}
  {{- end  -}}
{{- end -}}

{{- if in $validLanguageIDs $type -}}
  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams                       -}}

  {{/* Handle attributes and data */}}
  {{- $class      := $info.Data.class        | default $attributes.class                       -}}
  {{- $id         := $info.Data.id           | default $attributes.id                          -}}
  {{- $root       := $info.Data.root         | default $attributes.root                        -}}
  {{- $recurse    := $info.Data.recurse      | default $attributes.recurse     | default false -}}
  {{- $useSummary := $info.Data.use_summary  | default $attributes.use_summary | default false -}}

  {{/* Resolve the root section*/}}
  {{- $section := dict -}}
  {{- with $root -}}
    {{- $section = $page.GetPage $root -}}
  {{- else -}}
    {{- $section = $page -}}
  {{- end -}}

  {{/* Retrieve and trim the actual definition or summary for the section, if any */}}
  {{- $content := "" -}}
  {{- with $info.Markdown -}}
    {{- $trimParams   := dict "Text" $info.Markdown "TrimEOL" true                           -}}
    {{- $content       = partial "platen/utils/getLeadTrimmedText" $trimParams               -}}
    {{- $renderParams := dict "Page" $page "Content" $content "IndentCount" 2 "AsBlock" true -}}
    {{- $content       = partial "platen/utils/getPrettyRender" $renderParams                -}}
    {{- $content       = printf "  %s" $content                                              -}}
  {{- else -}}
    {{- if $useSummary -}}
      {{/*
        We use the with/else here and access $page.Params.summary instead of $page.Summary in the
        default function to avoid infinite recursion for pages with a section codeblock where the
        page is included in the root section; in those cases, the .Summary has to render the page,
        then truncate it, which means that the codeblock is called again from inside itself forever.

        Despite the documentation, setting `summary` in the front matter or specifying the magic
        more comment before the summary block doesn't fix this.
      */}}
      {{- $content       = $section.Description | default $section.Params.summary              -}}
      {{- $renderParams := dict "Page" $page "Content" $content "IndentCount" 2 "AsBlock" true -}}
      {{- $content       = partial "platen/utils/getPrettyRender" $renderParams                -}}
      {{- $content       = printf "  %s" $content                                              -}}
      {{- with $content -}}
      {{- else -}}
        {{- $content = $section.Summary -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- with $section.Pages -}}
    {{- $renderStrings := slice -}}

    {{/* Build the section div's attributes */}}
    {{- $divAttributes := slice -}}

    {{- $divClass := "platen-section" -}}
    {{- with $class -}}
      {{- $divClass = printf "%s %s" $divClass $class -}}
    {{- end -}}
    {{- $divAttributes = $divAttributes | append (printf `class="%s"` $divClass) -}}

    {{- with $id -}}
      {{- $divAttributes = $divAttributes | append (printf `id="%s"` $id) -}}
    {{- end -}}
    {{- $divAttributes = partial "platen/utils/getSafeAttributes" $divAttributes    -}}
    {{- $renderStrings = $renderStrings | append (printf `<div %s>` $divAttributes) -}}
    
    {{/* Add the leading content, if any */}}
    {{- with $content -}}
      {{- $renderStrings = $renderStrings | append $content -}}
    {{- end -}}

    {{/* Open the description list */}}
    {{- $renderStrings = $renderStrings | append "  <dl>" -}}
    
    {{/* Loop over the children and add their entries. Use a partial for recursion. */}}
    {{- range $child := $section.Pages -}}
      {{- $childParams  := dict "Page" $child "Recurse" $recurse               -}}
      {{- $childEntry   := partial "platen/features/section/item" $childParams -}}
      {{- $renderStrings = $renderStrings | append $childEntry                 -}}
    {{- end -}}

    {{/* Close the list and div, then join the strings */}}
    {{- $renderStrings = $renderStrings | append "  </dl>" "</div>" -}}
    {{- $renderedCode  = delimit $renderStrings "\n"                -}}
  {{- else -}}
    {{- warnf "Specified section '%s' has no child pages to list." $section.Name -}}
  {{- end -}}
{{- end -}}

{{- return $renderedCode -}}
