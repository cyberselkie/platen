{{- $params      := .                                  -}}
{{- $config      := site.Params.Platen.Features.Itchio -}}
{{- $page        := $params.Page                       -}}
{{- $destination := $params.Destination                -}}
{{- $title       := $params.Title                      -}}
{{- $text        := $params.PlainText                  -}}
{{- $isBlock     := $params.IsBlock                    -}}
{{- $ordinal     := $params.Ordinal                    -}}

{{- $renderedImage := "" -}}

{{- $prefixes := slice "itch:" -}}
{{- range $alias := $config.aliases -}}
  {{- $prefixes = $prefixes | append (printf "%s:" $alias) -}}
{{- end -}}

{{- $hasPrefix := false -}}
{{- $alt       := $text -}}

{{- range $prefix := $prefixes -}}
  {{- if and (not $hasPrefix) (hasPrefix $text $prefix) -}}
    {{- $hasPrefix = true -}}
    {{- $alt       = strings.TrimPrefix $prefix $text }}
  {{- end -}}
{{- end -}}

{{- if $hasPrefix -}}
  {{/* Retrieve attributes for block syntax image only */}}
  {{- $attributes := dict -}}

  {{/* Initialize iframe attribute list and mandatory values */}}
  {{- $iframeAttributes := slice -}}
  {{- $title            := ""    -}}

  {{/* Set default values */}}
  {{- $height := 167 -}}
  {{- $width  := 552 -}}

  {{- with $destination -}}
    {{- $url := printf "https://itch.io/embed/%s" $destination -}}

    {{/*
      Handle the alt text. If it's provided, use as title for iframe. Otherwise, assume the use of a
      preset which should have a title.
    */}}
    {{- with $alt -}}
      {{- $title = $alt -}}
    {{- else -}}
      {{/* Assume preset, implement later */}}
      {{- warnf "Finding itchio preset %s" $destination -}}
    {{- end -}}

    {{/* If the image is a block, handle the attributes. */}}
    {{/* Both should set the url and title */}}
    {{- if $isBlock -}}
      {{- $attributes       = $params.Attributes -}}
      {{- $dark            := $attributes.dark            | default false -}}
      {{- $square          := $attributes.square          | default false -}}
      {{- $linkback        := $attributes.linkback        | default false -}}
      {{- $backgroundColor := $attributes.background_color                -}}
      {{- $textColor       := $attributes.text_color                      -}}
      {{- $buttonColor     := $attributes.button_color                    -}}
      {{- $borderColor     := $attributes.border_color                    -}}
      {{- $borderWidth     := $attributes.border_width                    -}}
      {{- $urlQueryParams  := slice                                       -}}

      {{- if $linkback -}}
        {{- $urlQueryParams = $urlQueryParams | append "linkback=true" -}}
      {{- end -}}
      {{- if $dark -}}
        {{- $urlQueryParams = $urlQueryParams | append "dark=true" -}}
      {{- end -}}
      {{- if $square -}}
        {{- $width = 208 -}}
      {{- end -}}
      {{- with $backgroundColor -}}
        {{- $backgroundColor = strings.TrimPrefix "#" $backgroundColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `bg_color=%s` $backgroundColor) -}}
      {{- end -}}
      {{- with $textColor -}}
        {{- $textColor      = strings.TrimPrefix "#" $textColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `fg_color=%s` $textColor) -}}
      {{- end -}}
      {{- with $buttonColor -}}
        {{- $buttonColor    = strings.TrimPrefix "#" $buttonColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `link_color=%s` $buttonColor) -}}
      {{- end -}}
      {{- with $borderColor -}}
        {{- $borderColor    = strings.TrimPrefix "#" $borderColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `border_color=%s` $borderColor) -}}
      {{- end -}}
      {{- with $borderWidth -}}
        {{- $borderWidth = int $borderWidth -}}
        {{- if and (ge $borderWidth 0) (le $borderWidth 5) -}}
          {{- $urlQueryParams = $urlQueryParams | append (printf `border_width=%v` $borderWidth) -}}
        {{- else -}}
          {{- errorf "%s" (i18n "ErrorItchioInvalidBorderWidth" (print $borderWidth)) -}}
        {{- end -}}
      {{- end -}}
      {{- $urlQueryParams = delimit $urlQueryParams "&" -}}

      {{/* Add the query parameters to the url, if any */}}
      {{- with $urlQueryParams -}}
        {{- $url = printf "%s?%s" $url $urlQueryParams -}}
      {{- end -}}
    {{- end -}}

    {{- $iframeAttributes = $iframeAttributes | append (printf `src="%s"` $url) -}}

    {{- with $title -}}
        {{- $iframeAttributes = $iframeAttributes | append (printf `title="%s"` $title) -}}
    {{- else -}}
      {{- $message := i18n "ErrorItchioMissingTitle"}}
      {{- warnf "%s" $message -}}
    {{- end -}}

    {{- $iframeAttributes = $iframeAttributes | append `frameborder="0"`              -}}
    {{- $iframeAttributes = $iframeAttributes | append (printf `height="%v"` $height) -}}
    {{- $iframeAttributes = $iframeAttributes | append (printf `width="%v"`  $width)  -}}

    {{- $attributeParams := dict "Attributes" $iframeAttributes "IndentCount" 8       -}}
    {{- $attributes       = partial "platen/utils/getSafeAttributes" $attributeParams -}}
    {{- $renderedImage    = printf "<iframe %s></iframe>" $attributes                 -}}
  {{- else -}}
    {{- errorf (i18n "ErrorItchioMissingID" (dict "page" $page)) -}}
  {{- end -}}
{{- end -}}

{{- return $renderedImage -}}
