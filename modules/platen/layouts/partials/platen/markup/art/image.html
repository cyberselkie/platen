{{- $Params      := .                                                         -}}
{{- $Page        := $Params.Page                                              -}}
{{- $Destination := $Params.Destination                                       -}}
{{- $title       := $Params.Title                                             -}}
{{- $text        := $Params.PlainText                                         -}}
{{- $IsBlock     := $Params.IsBlock                                           -}}
{{- $Ordinal     := $Params.Ordinal                                           -}}
{{- $ConfigKey   := "platen.markup.art"                                       -}}
{{- $Config      := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases     := $Config.aliases                                           -}}
{{- $WorkPrefix  := "work:"                                                   -}}

{{- $renderedImage := "" -}}

{{- $prefixes := slice "art:" -}}
{{- range $alias := $Aliases -}}
  {{- $prefixes = $prefixes | append (printf "%s:" $alias) -}}
{{- end -}}

{{- $hasPrefix := false -}}
{{- $alt       := $text -}}

{{- range $prefix := $prefixes -}}
  {{- if and (not $hasPrefix) (hasPrefix $text $prefix) -}}
    {{- $hasPrefix = true                             -}}
    {{- $alt       = strings.TrimPrefix $prefix $text -}}
  {{- end -}}
{{- end -}}

{{- if $hasPrefix -}}
  {{/* Retrieve the defaults from data, init style and work opts */}}
  {{- $passedOptions := dict -}}
  {{- $mergedOptions := dict -}}
  {{- $workOptions   := dict -}}

  {{- with $Destination -}}
    {{- if hasPrefix $Destination $WorkPrefix -}}
      {{- $WorkPath     := strings.TrimPrefix $WorkPrefix $Destination  -}}
      {{- $passedOptions = merge $passedOptions (dict "work" $WorkPath) -}}
    {{- else -}}
      {{- $passedOptions = merge $passedOptions (dict "src" $Destination) -}}
    {{- end -}}
  {{- end -}}

  {{- with $alt -}}
    {{- $passedOptions = merge $passedOptions (dict "alt" $alt) -}}
  {{- end -}}

  {{- with $title -}}
    {{- $passedOptions = merge $passedOptions (dict "caption" $title) -}}
  {{- end -}}

  {{- if $IsBlock -}}
    {{- $attributes := $Params.Attributes -}}

    {{- $ValidAttributes := slice "class" "id" "content_warning" "style" "work" -}}
    {{- range $ValidAttribute := $ValidAttributes -}}
      {{- with (index $attributes $ValidAttribute) -}}
        {{- $passedOptions = merge $passedOptions (dict $ValidAttribute .) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- with $passedOptions.work -}}
    {{- $workOptions = partialCached "platen/markup/art/_getWork" . . -}}
  {{- end -}}

  {{- range $WorkKey, $WorkValue := $workOptions -}}
    {{- $MergedValue  := index $passedOptions $WorkKey | default $WorkValue -}}
    {{- $mergedOptions = merge $mergedOptions (dict $WorkKey $MergedValue)  -}}
  {{- end -}}
  {{- range $PassedKey, $PassedValue := $passedOptions -}}
    {{- with index $mergedOptions $PassedKey -}}
      {{/* Nothing to do, already merged */}}
    {{- else -}}
      {{/* Not defined in work options, add value from passed options */}}
      {{- $mergedOptions = merge $mergedOptions (dict $PassedKey $PassedValue) -}}
    {{- end -}}
  {{- end -}}

  {{- $Canonicalizing := dict "Page" $Page "Options" $mergedOptions                -}}
  {{- $Canonicalized  := partial "platen/markup/art/_canonicalize" $Canonicalizing -}}

  {{/*  Canonicalized! now we just need to call render and fix error/warnings.  */}}
  {{- $renderedImage = partial "platen/markup/art/_render" $Canonicalized -}}
{{- end -}}

{{- return $renderedImage -}}
