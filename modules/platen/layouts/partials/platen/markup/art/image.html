{{- $Params              := .                                                         -}}
{{- $Page                := $Params.Page                                              -}}
{{- $Attributes          := $Params.Attributes                                        -}}
{{- $Destination         := $Params.Destination                                       -}}
{{- $Title               := $Params.Title                                             -}}
{{- $Text                := $Params.PlainText                                         -}}
{{- $Ordinal             := $Params.Ordinal                                           -}}
{{/*  Retrieve settings from configuration  */}}
{{- $ConfigKey           := "platen.markup.art"                                       -}}
{{- $Config              := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases             := $Config.aliases                                           -}}
{{- $DefaultPrefixes     := slice "art"                                               -}}
{{/*  Define parameters for the getMergedLinkOptions partial  */}}
{{- $DestinationKey      := "src"                                                     -}}
{{- $PresetDotPathPrefix := "platen.art.works"                                        -}}
{{- $PresetKey           := "work"                                                    -}}
{{- $PresetPrefix        := "work:"                                                   -}}
{{- $StylesDotPathPrefix := "platen.art.styles"                                       -}}
{{- $TextKey             := "alt"                                                     -}}
{{- $TitleKey            := "text"                                                    -}}
{{- $ValidAttributes     := slice "class" "id" "content_warning" "style" "work"       -}}
{{/*  Define partials for easier calling/renaming  */}}
{{- $getMergedMarkupIDs      := "platen/utils/getMergedMarkupIDs"      -}}
{{- $getPrefixTrimmedAltText := "platen/utils/getPrefixTrimmedAltText" -}}
{{- $getMergedLinkOptions    := "platen/utils/getMergedLinkOptions"    -}}
{{- $canonicalize            := "platen/markup/art/_canonicalize"      -}}

{{/*  Initialize the return value for the markup  */}}
{{- $renderedImage := "" -}}

{{/*  Get the list of prefixes for this markup  */}}
{{- $MarkupIDParams := dict "Default" $DefaultPrefixes "Aliases" $Aliases "Suffix" true -}}
{{- $Prefixes       := partialCached $getMergedMarkupIDs $MarkupIDParams "art"          -}}

{{/*
    Check to see if the image link is this markup. If it is, the Value key will
    be set to the trimmed alt text. If it isn't, this will be an empty dict;
    this lets us use the `with` operator even when the trimmed alt text is an
    empty string.
*/}}
{{- $alt := partial $getPrefixTrimmedAltText (dict "Prefixes" $Prefixes "Text" $Text) -}}

{{- with $alt -}}
  {{/*  Retrieve and merge the passed options with the preset options  */}}
  {{- $mergeParams := dict "Attributes"          $Attributes
                           "Destination"         $Destination
                           "DestinationKey"      $DestinationKey
                           "Page"                $Page
                           "PresetDotPathPrefix" $PresetDotPathPrefix
                           "PresetKey"           $PresetKey
                           "PresetPrefix"        $PresetPrefix
                           "StylesDotPathPrefix" $StylesDotPathPrefix
                           "Text"                $alt.Value
                           "TextKey"             $TextKey
                           "Title"               $Title
                           "TitleKey"            $TitleKey
                           "ValidAttributes"     $ValidAttributes
  -}}
  {{- $mergedOptions  := partial $getMergedLinkOptions $mergeParams -}}
  {{/*
      Canonicalize the options to pick the right template and build the map
      of parameters to pass to it.
  */}}
  {{- $Canonicalizing := dict "Page" $Page "Options" $mergedOptions -}}
  {{- $Canonicalized  := partial $canonicalize $Canonicalizing      -}}

  {{/*  Render the image with the template from the canonicalized info  */}}
  {{- $renderedImage = partial $Canonicalized.Template $Canonicalized -}}
{{- end -}}

{{- return $renderedImage -}}
