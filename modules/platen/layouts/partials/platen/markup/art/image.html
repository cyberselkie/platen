{{- $Params      := .                                                                -}}
{{- $Page        := $Params.Page                                                     -}}
{{- $destination := $Params.Destination                                              -}}
{{- $title       := $Params.Title                                                    -}}
{{- $text        := $Params.PlainText                                                -}}
{{- $IsBlock     := $Params.IsBlock                                                  -}}
{{- $Ordinal     := $Params.Ordinal                                                  -}}
{{- $ConfigKey   := "platen.markup.art"                                              -}}
{{- $Config      := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases     := $Config.aliases                                                  -}}

{{- $renderedImage := "" -}}

{{- $prefixes := slice "art:" -}}
{{- range $alias := $Aliases -}}
  {{- $prefixes = $prefixes | append (printf "%s:" $alias) -}}
{{- end -}}

{{- $hasPrefix := false -}}
{{- $alt       := $text -}}

{{- range $prefix := $prefixes -}}
  {{- if and (not $hasPrefix) (hasPrefix $text $prefix) -}}
    {{- $hasPrefix = true                             -}}
    {{- $alt       = strings.TrimPrefix $prefix $text -}}
  {{- end -}}
{{- end -}}

{{- if $hasPrefix -}}
  {{/* Retrieve attributes for block syntax image only */}}
  {{- $attributes := dict -}}
  {{- $src := "" -}}

  {{- with $destination -}}
    {{- $asset    := dict                                                             -}}
    {{- $isRemote := or (in $destination "://") (strings.HasPrefix $destination "//") -}}
    {{- with $alt -}}
      {{- if not $isRemote -}}
        {{- $isStatic := strings.HasPrefix $destination "/"}}
        {{- if $isStatic -}}
          {{- $src = $destination -}}
        {{- else -}}
          {{- $asset = resources.Get $destination }}
        {{- end -}}
      {{- else -}}
        {{- $asset = resources.GetRemote $destination -}}
      {{- end -}}
    {{- else -}}
      {{/* Assume preset, implement later */}}
      {{- warnf "Finding art preset %s" $destination -}}
    {{- end -}}

    {{/* If the image is an asset, you can process it before insertion */}}
    {{- with $asset -}}
      {{/* Handle processing */}}
      {{- $src = $asset.RelPermalink -}}
    {{- end -}}

    {{/* If the image is a block, treat it like a figure; otherwise, warn about inline art. */}}
    {{- if $IsBlock -}}
      {{- $renderParams := dict "Source" $src "AltText" $alt "Page" $Page -}}
      {{- $attributes   := $Params.Attributes -}}
      
      {{- with $attributes.class -}}
        {{- $renderParams = merge $renderParams (dict "Class" .) -}}
      {{- end -}}
      
      {{- with $attributes.content_warning -}}
        {{- $renderParams = merge $renderParams (dict "ContentWarning" .) -}}
      {{- end -}}
      
      {{- with $attributes.caption -}}
        {{- $renderParams = merge $renderParams (dict "Caption" .) -}}
      {{- else -}}
        {{- $renderParams = merge $renderParams (dict "Caption" $title) -}}
      {{- end -}}

      {{- with $attributes.id -}}
        {{- $renderParams = merge $renderParams (dict "ID" . ) -}}
      {{- end -}}

      {{- $renderedImage = partial "platen/markup/art/render" $renderParams -}}
    {{- else -}}
      {{- $message := i18n "ErrorArtInlineImage" (dict "src" $src "page" $Page) -}}
      {{- errorf $message -}}
    {{- end -}}
  {{- else -}}
    {{- $message := i18n "ErrorArtMissingSourceImage" (dict "page" $Page) -}}
    {{- errorf $message -}}
  {{- end -}}
{{- end -}}

{{- return $renderedImage -}}
