{{- $params := . -}}

{{- $page           := $params.Page           -}}
{{- $src            := $params.Source         -}}
{{- $alt            := $params.AltText        -}}
{{- $class          := $params.Class          -}}
{{- $contentWarning := $params.ContentWarning -}}
{{- $caption        := $params.Caption        -}}
{{- $id             := $params.ID             -}}

{{- with $caption -}}
  {{- $trimParams := dict "Text" $caption "TrimEOL" true                   -}}
  {{- $caption     = partial "platen/utils/getLeadTrimmedText" $trimParams -}}
{{- end -}}

{{/* Define classes for easy reference elsewhere */}}
{{- $artClass := "platen-art"             -}}
{{- $cwClass  := "platen-content-warning" -}}

{{/* Initialize the render strings */}}
{{- $renderStrings := slice -}}

{{/* Define the attribute list for the figure element */}}
{{- $figureAttributes := slice -}}
{{- with $id -}}
  {{- $figureAttributes = $figureAttributes | append (printf `id="%s"` $id) -}}
{{- end -}}
{{- $figureClass      := slice $artClass -}}
{{- with $contentWarning -}}
  {{- $figureClass = $figureClass | append $cwClass -}}
{{- end -}}
{{- with $class -}}
  {{- $figureClass = $figureClass | append $class -}}
{{- end -}}
{{- $figureClass      = delimit $figureClass " "                                         -}}
{{- $figureAttributes = $figureAttributes | append (printf `class="%s"` $figureClass)    -}}
{{- $figureAttributes = partial "platen/utils/getSafeAttributes" $figureAttributes       -}}
{{- $renderStrings    = $renderStrings | append (printf "<figure %s>" $figureAttributes) -}}

{{/* Handle the content warning, if needed */}}
{{- $cwID               := "" -}}
{{- with $contentWarning -}}
  {{- $cwID             = printf "content-warning-%s" (lower $contentWarning | urlize) -}}
  {{- $inputAttributes := slice `type="checkbox"`
                         | append (printf `class="%s"` $cwClass)
                         | append (printf `name="toggle-%s"` $cwID)
                         | append (printf `id="%s"`   $cwID)
  -}}
  {{- $attributeParams := dict "Attributes" $inputAttributes "IndentCount" 9        -}}
  {{- $inputAttributes  = partial "platen/utils/getSafeAttributes" $attributeParams -}}
  {{- $renderStrings    = $renderStrings
                          | append (printf "  <input %s/>" $inputAttributes)
                          | append (printf `  <label for="%s">%s</label>` $cwID $contentWarning)
  -}}
{{- end -}}

{{/* Define the attibute list for the img element */}}
{{- $imageAttributes := slice (printf `src="%s"` $src)
                        | append (printf `alt="%s"` $alt)
-}}
{{- $imageAttributes = partial "platen/utils/getSafeAttributes" $imageAttributes      -}}
{{- $renderStrings   = $renderStrings | append (printf "  <img %s>" $imageAttributes) -}}

{{- with $caption -}}
  {{- $renderParams := dict "Page"        $page
                            "Content"     $caption
                            "IndentCount" 4
                            "AsBlock"     true
  -}}
  {{- $renderedcaption := partial "platen/utils/getPrettyRender" $renderParams              -}}
  {{- $figCaption      := printf "  <figcaption>\n    %s\n  </figcaption>" $renderedcaption -}}
  {{- $renderStrings    = $renderStrings | append $figCaption                               -}}
{{- end -}}

{{/* Add the closing tag for the figure */}}
{{- $renderStrings = $renderStrings | append "</figure>" -}}

{{/* Combine render strings */}}
{{- $renderString := delimit $renderStrings "\n"   -}}
{{- $renderString  = printf  "%s\n\n" $renderString -}}

{{/* Render */}}
{{- return $renderString -}}