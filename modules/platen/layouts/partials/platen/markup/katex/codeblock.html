{{- $params     := .                                   -}}
{{- $config     := site.Params.Platen.Markup.Katex   -}}
{{- $aliases    := $config.aliases                     -}}
{{- $page       := $params.Page                        -}}
{{- $position   := $params.Position                    -}}
{{- $definition := $params.Inner                       -}}
{{- $type       := $params.Type | lower                -}}
{{- $attributes := $params.Attributes                  -}}

{{- $renderedCode := "" -}}

{{- $mathLanguageIDs := slice "katex" "math" -}}
{{- $chemLanguageIDs  := slice "chem"         -}}
{{- with $aliases -}}
  {{- if (reflect.IsSlice $aliases) -}}
    {{- $mathLanguageIDs = union $mathLanguageIDs $aliases -}}
  {{- else if (reflect.IsMap $aliases) -}}
    {{- $mathAliases := $aliases.math -}}
    {{- $chemAliases := $aliases.chem -}}
    {{- with $mathAliases -}}
      {{- if (reflect.IsMap $mathAliases) -}}
        {{- errorf "Invalid definition for Platen.Markup.Katex.Aliases.Group; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $mathAliases) -}}
        {{- $mathLanguageIDs = union $mathLanguageIDs $mathAliases -}}
      {{- else -}}
        {{- $mathLanguageIDs = $mathLanguageIDs | append (print $mathAliases) -}}
      {{- end  -}}
    {{- end -}}
    {{- with $chemAliases -}}
      {{- if (reflect.IsMap $chemAliases) -}}
        {{- errorf "Invalid definition for Platen.Markup.Katex.Aliases.Entry; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $chemAliases) -}}
        {{- $chemLanguageIDs = union $chemLanguageIDs $chemAliases -}}
      {{- else -}}
        {{- $chemLanguageIDs = $chemLanguageIDs | append (print $chemAliases) -}}
      {{- end  -}}
    {{- end -}}
  {{- else -}}
    {{- $mathLanguageIDs = $mathLanguageIDs | append (print $aliases) -}}
  {{- end  -}}
{{- end -}}

{{- $validLanguageIDs := union $mathLanguageIDs $chemLanguageIDs -}}

{{- $chemPattern      := `\\ce\{(.|\s)+?\}` -}}

{{- if in $validLanguageIDs $type -}}
  {{- $params.Page.Store.Set "hasKatex" true             -}}
  {{- $chemUsages := findRE $chemPattern     $definition -}}
  {{- $isChemType := in     $chemLanguageIDs $type       -}}
  {{- if or $isChemType (gt $chemUsages 0) -}}
    {{- $params.Page.Store.Set "hasChem" true -}}
  {{- end -}}

  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams                       -}}

  {{- $caption     := $info.Data.caption                                                 -}}
  {{- $asFigure    := $info.Data.asFigure | default $attributes.asFigure | default false -}}
  {{- $class       := $info.Data.class    | default $attributes.class                    -}}
  {{- $id          := $info.Data.id       | default $attributes.id                       -}}
  {{- $displayMode := $info.Data.display  | default $attributes.display  | default true  -}}
  {{- $trimParams  := dict "Text" $info.Markdown "TrimEOL" true                         -}}
  {{- $definition  := partial "platen/utils/getLeadTrimmedText" $trimParams             -}}

  {{- with $caption -}}
    {{- $asFigure = true -}}
  {{- end -}}

  {{- $spanAttributes := slice -}}
  {{- $renderedSpan   := "" -}}
  {{- with $class -}}
    {{- $spanAttributes = $spanAttributes | append (printf `class="%s"` $class) -}}
  {{- end -}}

  {{- with $id -}}
    {{- if not $asFigure -}}
      {{- $spanAttributes = $spanAttributes | append (printf `id="%s"` $id) -}}
    {{- end -}}
  {{- end -}}

  {{- $indentCount      := cond $asFigure 8 6                                           -}}
  {{- $attributeParams  := dict "Attributes" $spanAttributes "IndentCount" $indentCount -}}
  {{- $spanAttributes    = partial "platen/utils/getSafeAttributes" $attributeParams    -}}
  {{- $mungedDefinition := printf "    %s" (delimit (split $definition "\n") "\n    ")  -}}
  {{- if $displayMode -}}
    {{- $renderedSpan = printf "\n  \\[\n%s\n  \\]" $mungedDefinition -}}
  {{- else -}}
    {{- $renderedSpan = printf "\n  \\(\n%s\n  \\)" $mungedDefinition -}}
  {{- end -}}
  {{- with $spanAttributes -}}
    {{- $renderedSpan = printf "<div %s>%s\n</div>" $spanAttributes $renderedSpan -}}
  {{- else -}}
    {{- $renderedSpan = printf "<div>%s\n</div>" $renderedSpan -}}
  {{- end -}}

  {{- if $asFigure -}}
    {{- $figureAttributes := slice -}}
    {{- with $id -}}
      {{- $figureAttributes = $figureAttributes | append (printf `id="%s"` $id) -}}
    {{- end -}}
    {{- with $class -}}
      {{- $figureAttributes = $figureAttributes | append (printf `class="%s"` $class) -}}
    {{- end -}}
    {{- $attributeParams := dict "Attributes" $figureAttributes "IndentCount" 8       -}}
    {{- $figureAttributes = partial "platen/utils/getSafeAttributes" $attributeParams -}}
    {{- with $figureAttributes -}}
      {{- $figureAttributes = printf " %s" $figureAttributes -}}
    {{- end -}}
    {{- $renderedCode     = printf "<figure%s>" $figureAttributes                    -}}

    {{- with $caption -}}
      {{- $atTop             := false    -}}
      {{- $text              := $caption -}}
      {{- if reflect.IsMap $caption -}}
        {{- $atTop = default $atTop $caption.AtTop -}}
        {{- $text  = $caption.Text                 -}}
      {{- end -}}

      {{- $renderParams      := dict "Page"        $page
                                     "Content"     $text
                                     "IndentCount" 4
      -}}
      {{- $renderedcaption := partial "platen/utils/getPrettyRender" $renderParams              -}}
      {{- $captionCode     := printf "  <figcaption>\n    %s\n  </figcaption>" $renderedcaption -}}
      {{- if $atTop -}}
        {{- $renderedCode = printf "%s\n  %s\n%s" $renderedCode $captionCode $renderedSpan -}}
      {{- else -}}
        {{- $renderedCode = printf "%s\n  %s\n%s" $renderedCode $renderedSpan $captionCode -}}
      {{- end -}}
      {{- $renderedCode = printf "%s\n</figure>" $renderedCode -}}
    {{- end -}}
  {{- else -}}
    {{- $renderedCode = $renderedSpan -}}
  {{- end -}}
{{- end -}}

{{- return $renderedCode -}}