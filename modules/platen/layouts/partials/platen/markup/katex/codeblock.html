{{- $Params     := .                                                                -}}
{{- $Page       := $Params.Page                                                     -}}
{{- $Position   := $Params.Position                                                 -}}
{{- $definition := $Params.Inner                                                    -}}
{{- $type       := $Params.Type | lower                                             -}}
{{- $Attributes := $Params.Attributes                                               -}}
{{- $ConfigKey  := "platen.markup.katex"                                            -}}
{{- $Config     := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases    := $Config.aliases                                                  -}}

{{- $renderedCode := "" -}}

{{- $mathLanguageIDs := slice "katex" "math" -}}
{{- $chemLanguageIDs  := slice "chem"         -}}
{{- with $Aliases -}}
  {{- if (reflect.IsSlice $Aliases) -}}
    {{- $mathLanguageIDs = union $mathLanguageIDs $Aliases -}}
  {{- else if (reflect.IsMap $Aliases) -}}
    {{- $mathAliases := $Aliases.math -}}
    {{- $chemAliases := $Aliases.chem -}}
    {{- with $mathAliases -}}
      {{- if (reflect.IsMap $mathAliases) -}}
        {{- errorf "Invalid definition for platen.markup.katex.aliases.math; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $mathAliases) -}}
        {{- $mathLanguageIDs = union $mathLanguageIDs $mathAliases -}}
      {{- else -}}
        {{- $mathLanguageIDs = $mathLanguageIDs | append (print $mathAliases) -}}
      {{- end  -}}
    {{- end -}}
    {{- with $chemAliases -}}
      {{- if (reflect.IsMap $chemAliases) -}}
        {{- errorf "Invalid definition for platen.markup.katex.aliases.chemistry; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $chemAliases) -}}
        {{- $chemLanguageIDs = union $chemLanguageIDs $chemAliases -}}
      {{- else -}}
        {{- $chemLanguageIDs = $chemLanguageIDs | append (print $chemAliases) -}}
      {{- end  -}}
    {{- end -}}
  {{- else -}}
    {{- $mathLanguageIDs = $mathLanguageIDs | append (print $Aliases) -}}
  {{- end  -}}
{{- end -}}

{{- $validLanguageIDs := union $mathLanguageIDs $chemLanguageIDs -}}

{{- $ChemPattern      := `\\ce\{(.|\s)+?\}` -}}

{{- if in $validLanguageIDs $type -}}
  {{- $Params.Page.Store.Set "_hasKatex" true            -}}
  {{- $chemUsages := findRE $ChemPattern     $definition -}}
  {{- $isChemType := in     $chemLanguageIDs $type       -}}
  {{- if or $isChemType (gt $chemUsages 0) -}}
    {{- $Params.Page.Store.Set "_hasChem" true -}}
  {{- end -}}

  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams                       -}}

  {{- $caption         := $info.Data.caption                                                   -}}
  {{- $captionPosition := $info.Data.caption_position | default "bottom"                       -}}
  {{- $asFigure        := $info.Data.as_figure | default $Attributes.as_figure | default false -}}
  {{- $class           := $info.Data.class     | default $Attributes.class                     -}}
  {{- $id              := $info.Data.id        | default $Attributes.id                        -}}
  {{- $displayMode     := $info.Data.display   | default $Attributes.display  | default true   -}}
  {{- $trimParams      := dict "Text" $info.Markdown "TrimEOL" true                            -}}
  {{- $definition      := partial "platen/utils/getLeadTrimmedText" $trimParams                -}}

  {{- with $caption -}}
    {{- $asFigure = true -}}
  {{- end -}}

  {{- with $captionPosition -}}
    {{- $ValidPositions := slice "top" "bottom" -}}
    {{- if not (in $ValidPositions $captionPosition) -}}
      {{- errorf "%s: Specified caption position '%s' is invalid. Must be one of: '%s'"
                 $Position $captionPosition (delimit $ValidPositions "', '" "', or '")
      -}}
    {{- end -}}
  {{- end -}}

  {{- $spanAttributes := slice -}}
  {{- $renderedSpan   := "" -}}
  {{- with $class -}}
    {{- $spanAttributes = $spanAttributes | append (printf `class="%s"` $class) -}}
  {{- end -}}

  {{- with $id -}}
    {{- if not $asFigure -}}
      {{- $spanAttributes = $spanAttributes | append (printf `id="%s"` $id) -}}
    {{- end -}}
  {{- end -}}

  {{- $indentCount      := cond $asFigure 8 6                                           -}}
  {{- $attributeParams  := dict "Attributes" $spanAttributes "IndentCount" $indentCount -}}
  {{- $spanAttributes    = partial "platen/utils/getSafeAttributes" $attributeParams    -}}
  {{- $mungedDefinition := printf "    %s" (delimit (split $definition "\n") "\n    ")  -}}
  {{- if $displayMode -}}
    {{- $renderedSpan = printf "\n  \\[\n%s\n  \\]" $mungedDefinition -}}
  {{- else -}}
    {{- $renderedSpan = printf "\n  \\(\n%s\n  \\)" $mungedDefinition -}}
  {{- end -}}
  {{- with $spanAttributes -}}
    {{- $renderedSpan = printf "<div %s>%s\n</div>" $spanAttributes $renderedSpan -}}
  {{- else -}}
    {{- $renderedSpan = printf "<div>%s\n</div>" $renderedSpan -}}
  {{- end -}}

  {{- if $asFigure -}}
    {{- $figureAttributes := slice -}}
    {{- with $id -}}
      {{- $figureAttributes = $figureAttributes | append (printf `id="%s"` $id) -}}
    {{- end -}}
    {{- with $class -}}
      {{- $figureAttributes = $figureAttributes | append (printf `class="%s"` $class) -}}
    {{- end -}}
    {{- $attributeParams := dict "Attributes" $figureAttributes "IndentCount" 8       -}}
    {{- $figureAttributes = partial "platen/utils/getSafeAttributes" $attributeParams -}}
    {{- with $figureAttributes -}}
      {{- $figureAttributes = printf " %s" $figureAttributes -}}
    {{- end -}}
    {{- $renderedCode     = printf "<figure%s>" $figureAttributes -}}

    {{- with $caption -}}
      {{- $renderParams      := dict "Page"        $Page
                                     "Content"     $caption
                                     "IndentCount" 4
      -}}
      {{- $renderedcaption := partial "platen/utils/getPrettyRender" $renderParams              -}}
      {{- $captionCode     := printf "  <figcaption>\n    %s\n  </figcaption>" $renderedcaption -}}
      {{- if eq "top" $captionPosition -}}
        {{- $renderedCode = printf "%s\n  %s\n%s" $renderedCode $captionCode $renderedSpan -}}
      {{- else -}}
        {{- $renderedCode = printf "%s\n  %s\n%s" $renderedCode $renderedSpan $captionCode -}}
      {{- end -}}
      {{- $renderedCode = printf "%s\n</figure>" $renderedCode -}}
    {{- end -}}
  {{- else -}}
    {{- $renderedCode = $renderedSpan -}}
  {{- end -}}
{{- end -}}

{{- return $renderedCode -}}
