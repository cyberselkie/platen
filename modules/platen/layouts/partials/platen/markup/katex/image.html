{{- $Params      := .                                                                -}}
{{- $Page        := $Params.Page                                                     -}}
{{- $destination := $Params.Destination                                              -}}
{{- $title       := $Params.Title                                                    -}}
{{- $text        := $Params.PlainText                                                -}}
{{- $IsBlock     := $Params.IsBlock                                                  -}}
{{- $Prdinal     := $Params.Ordinal                                                  -}}
{{- $ConfigKey   := "platen.markup.katex"                                            -}}
{{- $Config      := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases     := $Config.aliases                                                  -}}

{{- $renderedImage := "" -}}

{{- $mathPrefixes  := slice "katex"   "math" -}}
{{- $chemPrefixes  := slice "chem"           -}}
{{- with $Aliases -}}
  {{- if (reflect.IsSlice $Aliases) -}}
    {{- $mathPrefixes = union $mathPrefixes $Aliases -}}
  {{- else if (reflect.IsMap $Aliases) -}}
    {{- $mathAliases := $Aliases.math -}}
    {{- $chemAliases := $Aliases.chem -}}
    {{- with $mathAliases -}}
      {{- if (reflect.IsMap $mathAliases) -}}
        {{- errorf "Invalid definition for platen.markup.katex.aliases.math; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $mathAliases) -}}
        {{- $mathPrefixes = union $mathPrefixes $mathAliases -}}
      {{- else -}}
        {{- $mathPrefixes = $mathPrefixes | append (print $mathAliases) -}}
      {{- end  -}}
    {{- end -}}
    {{- with $chemAliases -}}
      {{- if (reflect.IsMap $chemAliases) -}}
        {{- errorf "Invalid definition for platen.markup.katex.aliases.chemistry; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $chemAliases) -}}
        {{- $chemPrefixes = union $chemPrefixes $chemAliases -}}
      {{- else -}}
        {{- $chemPrefixes = $chemPrefixes | append (print $chemAliases) -}}
      {{- end  -}}
    {{- end -}}
  {{- else -}}
    {{- $mathPrefixes = $mathPrefixes | append (print $Aliases) -}}
  {{- end  -}}
{{- end -}}

{{- $validPrefixes := apply (union $mathPrefixes $chemPrefixes) "printf" "%s:" "." -}}
{{- $ChemPattern   := `\\ce\{(.|\s)+?\}`                                           -}}

{{- $hasPrefix := false -}}
{{- $alt       := $text -}}

{{- range $prefix := $validPrefixes -}}
  {{- if and (not $hasPrefix) (hasPrefix $text $prefix) -}}
    {{- $hasPrefix     = true                                                  -}}
    {{- $alt           = strings.TrimPrefix $prefix $text                      -}}
    {{- $Params.Page.Store.Set "_hasKatex" true                                -}}
    {{- $chemUsages   := findRE $ChemPattern     $alt                          -}}
    {{- $isChemPrefix := in     $chemPrefixes (strings.TrimSuffix ":" $prefix) -}}
    {{- if or $isChemPrefix (gt $chemUsages 0) -}}
      {{- $Params.Page.Store.Set "_hasChem" true -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- if $hasPrefix -}}
  {{- with $alt -}}
    {{- $formula      := printf "\\(%s\\)"        $alt     -}}
    {{- $renderedImage = printf "<span>%s</span>" $formula -}}
  {{- else -}}
    {{- with $destination -}}
      {{/* Assume preset, define later */}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- return $renderedImage -}}
