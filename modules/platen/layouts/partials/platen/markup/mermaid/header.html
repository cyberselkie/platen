{{- $Context          := .                                     -}}
{{- $IntegrityPartial := "platen/utils/getIntegrityAttributes" -}}

{{- if $Context.Store.Get "_hasMermaid" -}}
  {{/* Get the Mermaid URL */}}
  {{- $Version := partial "platen/param/resolve" (
        dict "Config"  "platen.markup.mermaid.version"
             "Param"   "platen.markup.mermaid.version"
             "Context" $Context
      )
  -}}
  {{- $UrlPrefix     := "https://cdn.jsdelivr.net/npm"                                      -}}
  {{- $libraryURL    := printf "%s/mermaid@%v/dist/mermaid.esm.min.mjs" $UrlPrefix $Version -}}
  {{- $libraryAttributes := slice "defer"
                            | append (printf `src="%s"` $libraryURL)
                            | append `type="module"`
  -}}
  {{- $attributeParams   := dict "Attributes" $libraryAttributes "IndentCount" 10     -}}
  {{- $libraryAttributes  = partialCached "platen/utils/getSafeAttributes" $attributeParams -}}
  {{- $libraryScript     := printf "<script %s></script>" $libraryAttributes          -}}

  {{/* Get the mermaid site config */}}
  {{- $mermaidConfig := resources.Get "scripts/markup/mermaid/config.json" -}}

  {{/* Build the mermaid script */}}
  {{- $ScriptParams := dict "Config"          $mermaidConfig.Content
                            "LibraryUrl"      $libraryURL
                            "WaitForShoelace" true
  -}}
  {{- $ScriptResource   :=  resources.Get "scripts/markup/mermaid/init.js"
                            | resources.ExecuteAsTemplate "scripts/mermaid/init.js" $ScriptParams
                            | resources.Fingerprint
  -}}
  {{- $ScriptIntegrity  := partialCached $IntegrityPartial $ScriptResource "MermaidInit"      -}}
  {{- $scriptAttributes := slice (printf `src="%s"` $ScriptResource.RelPermalink) $ScriptIntegrity `type="module"` -}}
  {{- $scriptAttributes  = delimit $scriptAttributes " "                                           -}}
  {{- $Script           := printf "<script %s></script>" $scriptAttributes                         -}}

  {{/* Render */}}
  {{- delimit (slice $libraryScript $Script) "\n  " | safeHTML -}}
{{- end -}}
