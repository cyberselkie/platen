{{- $Params     := .                                   -}}
{{- $Config     := site.Params.platen.markup.details   -}}
{{- $Aliases    := $Config.aliases                     -}}
{{- $Page       := $Params.Page                        -}}
{{- $Position   := $Params.Position                    -}}
{{- $definition := $Params.Inner                       -}}
{{- $type       := $Params.Type | lower                -}}
{{- $Attributes := $Params.Attributes                  -}}

{{- $renderedCode := "" -}}

{{- $validLanguageIDs := slice "details" -}}
{{- with $Aliases -}}
  {{- if (reflect.IsSlice $Aliases) -}}
    {{- $validLanguageIDs = union $validLanguageIDs $Aliases -}}
  {{- else -}}
    {{- $validLanguageIDs = $validLanguageIDs | append (print $Aliases) -}}
  {{- end  -}}
{{- end -}}

{{- if in $validLanguageIDs $type -}}
  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams                       -}}

  {{/* Handle attributes and data */}}
  {{- $class      := $info.Data.class    | default $Attributes.class                        -}}
  {{- $summary    := $info.Data.summary  | default $Attributes.summary  | default "Details" -}}
  {{- $linkable   := $info.Data.linkable | default $Attributes.linkable | default true      -}}
  {{- $open       := $info.Data.open     | default $Attributes.open     | default true      -}}
  {{- $id         := $info.Data.id
                     | default $Attributes.id
                     | default (lower $summary | urlize)
  -}}

  {{/* Retrieve and trim the actual definition */}}
  {{- $trimParams   := dict "Text" $info.Markdown "TrimEOL" true                           -}}
  {{- $content      := partial "platen/utils/getLeadTrimmedText" $trimParams               -}}
  {{- $renderParams := dict "Page" $Page "Content" $content "IndentCount" 4 "AsBlock" true -}}
  {{- $content       = partial "platen/utils/getPrettyRender" $renderParams                -}}

  {{/* Pre-render the summary */}}
  {{- $summary = $summary | $Page.RenderString -}}

  {{/* Build the list of attributes for the container element */}}
  {{- $detailsAttributes := slice -}}
  {{- $summaryAttributes := ""    -}}
  {{- if $linkable -}}
    {{- $summaryAttributes = printf ` id="%s"` $id -}}
  {{- end -}}
  {{- $classes           := slice "platen-details" -}}
  {{- with $class -}}
    {{- $classes = $classes | append $class -}}
  {{- end -}}
  {{- $classes           = delimit $classes " "                                       -}}
  {{- $detailsAttributes = $detailsAttributes | append (printf `class="%s"` $classes) -}}
  {{- if $open -}}
    {{- $detailsAttributes = $detailsAttributes | append "open" -}}
  {{- end -}}
  {{- $detailsAttributes = partial "platen/utils/getSafeAttributes" $detailsAttributes -}}
  {{- $lines := slice (printf "<details %s>" $detailsAttributes)
                      (printf "  <summary%s>\n  %s\n</summary>" $summaryAttributes $summary)
                      `  <div class="markdown-inner">`
                      (printf "    %s" $content)
                      "  </div>"
                      "</details>"
  -}}
  {{- $renderedCode = delimit $lines "\n" -}}
{{- end -}}

{{- return $renderedCode -}}
