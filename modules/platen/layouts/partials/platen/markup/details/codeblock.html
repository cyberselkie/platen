{{- $Params     := .                                                                -}}
{{- $Page       := $Params.Page                                                     -}}
{{- $Position   := $Params.Position                                                 -}}
{{- $definition := $Params.Inner                                                    -}}
{{- $type       := $Params.Type | lower                                             -}}
{{- $Attributes := $Params.Attributes                                               -}}
{{- $ConfigKey  := "platen.markup.details"                                          -}}
{{- $Config     := partialCached "platen/param/getKey" $ConfigKey $ConfigKey        -}}
{{- $Aliases    := $Config.aliases                                                  -}}
{{- $DefaultIDs := slice "details"                                                  -}}

{{/*  Define partials for easier calling/renaming  */}}
{{- $getCodeblockInfo   := "platen/utils/getCodeblockInfo"     -}}
{{- $mungeHeadingLevel  := "platen/utils/mungeHeadingLevel"    -}}
{{- $getLeadTrimmedText := "platen/utils/getLeadTrimmedText"   -}}
{{- $getMergedClasses   := "platen/utils/getMergedClasses"     -}}
{{- $getMergedMarkupIDs := "platen/utils/getMergedMarkupIDs"   -}}
{{- $getPrettyRender    := "platen/utils/getPrettyRender"      -}}
{{- $getSafeAttributes  := "platen/utils/getSafeAttributes"    -}}
{{- $TemplateFolder     := "platen/markup/details/templates"   -}}
{{- $renderTemplate     := printf "%s/default" $TemplateFolder -}}

{{/*
    Initialize the rendered code string. This is returned to the caller. If it's empty,
    this renderer isn't applied. If it has any content, that's used as the rendered
    output for the codeblock from the Markdown. Only the first renderer that returns
    content is used.
*/}}
{{- $renderedCode := "" -}}

{{/*  Retrieve the valid language IDs  */}}
{{- $MarkupIDParams   := dict "Default" $DefaultIDs "Aliases" $Aliases               -}}
{{- $validLanguageIDs := partialCached $getMergedMarkupIDs $MarkupIDParams "details" -}}

{{- if in $validLanguageIDs $type -}}
  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial $getCodeblockInfo $infoParams                                     -}}

  {{- $Merging := dict "Attributes" $Attributes
                       "YamlOptions" $info.Data
                       "Position"   $Position
                       "PresetDotPathPrefix" "platen.details"
  -}}
  {{- $Merged         := partial "platen/utils/getMergedCodeblockOptions" $Merging -}}
  {{- $Canonicalizing := dict "Config"   $Config
                              "Position" $Position
                              "Page"     $Page
                              "Options"  $Merged
                              "Markdown" $info.Markdown
  -}}
  {{- $Canonicalized  := partial "platen/markup/details/_canonicalize" $Canonicalizing -}}

  {{/*  Render the codeblock with the template from the canonicalized info  */}}
  {{- $renderedCode = partial $Canonicalized.Template $Canonicalized -}}
{{- end -}}

{{- return $renderedCode -}}
