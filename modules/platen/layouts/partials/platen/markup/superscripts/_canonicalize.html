{{- $Params       := .                                             -}}
{{- $Page         := $Params.Page                                  -}}
{{- $Options      := $Params.Options                               -}}
{{- $DefaultStyle := site.Data.platen.superscripts.styles._default -}}
{{- $style        := dict                                          -}}
{{- $canonical    := dict                                          -}}

{{/*  If the options specified one or more styles, retrieve and merge them over default  */}}
{{- $styles := slice -}}
{{- range $Options.styles -}}
  {{- $styles = $styles | append . -}}
{{- end -}}
{{- with $Options.style -}}
  {{- $styles = $styles | append . -}}
{{- end -}}

{{- with $styles -}}
  {{- if not (reflect.IsSlice $styles) -}}
    {{- $styles = slice $styles -}}
  {{- end -}}

  {{- range $stylePath := $styles -}}
    {{- $mergingStyle := partialCached "platen/markup/superscripts/_getStyle" $stylePath $stylePath -}}
    {{- $mergeParams  := dict "BaseMap" $style "MergingMap" $mergingStyle                        -}}
    {{- $style         = partialCached "platen/utils/getMergedMap" $mergeParams $mergeParams     -}}
  {{- end -}}

  {{- $mergeParams := dict "BaseMap" $DefaultStyle "MergingMap" $style "JoinArrays" true  -}}
  {{- $style        = partialCached "platen/utils/getMergedMap" $mergeParams $mergeParams -}}
{{- else -}}
  {{/*  With no style specified, use the default  */}}
  {{- $style = $DefaultStyle -}}
{{- end -}}

{{/*  Merge the specified class list with any from the merged style(s)  */}}
{{- with $Options.class -}}
  {{- $styleClasses := $style.classes -}}

  {{- range $class := split $Options.class " " -}}
    {{- $styleClasses = $styleClasses | append $class -}}
  {{- end -}}

  {{- $style = merge $style (dict "classes" $styleClasses) -}}
{{- end -}}

{{/*  Convert the merged styles into HTML attributes, starting with classes  */}}
{{- $attributes := slice -}}
{{- with $style.classes -}}
  {{- $ClassList      := delimit . " "                        -}}
  {{- $ClassAttribute := printf `class="%s"` $ClassList       -}}
  {{- $attributes      = $attributes | append $ClassAttribute -}}
{{- end -}}

{{/*  Add the remaining attributes to the list  */}}
{{- range $Name, $Value := $style.html_attributes -}}
  {{- $Attribute := printf `%s="%v"` $Name $Value   -}}
  {{- $attributes = $attributes | append $Attribute -}}
{{- end -}}

{{- $canonical = merge $canonical (dict "Attributes" $attributes) -}}

{{/*  If text was specified by preset or inline, pass it back; otherwise return empty string  */}}
{{- with $Options.text -}}
  {{- $canonical = merge $canonical (dict "Text" .) -}}
{{- else -}}
  {{- $canonical = merge $canonical (dict "Text" "") -}}
{{- end -}}

{{- return $canonical -}}
