{{- $Params          := .                   -}}
{{- $Page            := $Params.Page        -}}
{{- $Attributes      := $Params.Attributes  -}}
{{- $Destination     := $Params.Destination -}}
{{- $Title           := $Params.Title       -}}
{{- $Text            := $Params.Text        -}}
{{- $Ordinal         := $Params.Ordinal     -}}
{{/*  Retrieve settings from configuration  */}}
{{- $ConfigKey       := "platen.markup.buttons"                                   -}}
{{- $Config          := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases         := $Config.aliases                                           -}}
{{- $DefaultPrefixes := slice "button" "btn"                                      -}}
{{/*  Define parameters for the getMergedLinkOptions partial  */}}
{{- $PresetDotPathPrefix := "platen.buttons"               -}}
{{- $PresetKeysToRender  := slice "text"                   -}}
{{- $TextKey             := "label_text"                   -}}
{{- $TitleKey            := "label_icon"                   -}}
{{- $ValidAttributes     := slice "circle"     "class"       "download_name" "height"
                                  "label_icon" "legacy"      "outline"       "outline"
                                  "pill"       "prefix_icon" "preset"        "rel"
                                  "size"       "style"       "suffix_icon"   "target"
                                  "type"       "variant"     "width"
-}}
{{/*  Define partials for easier calling/renaming  */}}
{{- $getMergedMarkupIDs      := "platen/utils/getMergedMarkupIDs"      -}}
{{- $getPrefixTrimmedAltText := "platen/utils/getPrefixTrimmedAltText" -}}
{{- $getMergedLinkOptions    := "platen/utils/getMergedLinkOptions"    -}}
{{- $canonicalize            := "platen/markup/buttons/_canonicalize"  -}}
{{- $render                  := "platen/markup/buttons/_render"        -}}
{{/*  Initialize rendered image string for returning  */}}
{{- $renderedImage := "" -}}
{{/*  Get the list of valid prefixes for this markup  */}}
{{- $MarkupIDParams := dict "Default" $DefaultPrefixes "Aliases" $Aliases "Suffix" true -}}
{{- $Prefixes       := partialCached $getMergedMarkupIDs $MarkupIDParams "button"       -}}
{{/*
    Check to see if the image link is this markup. If it is, the Value key will
    be set to the trimmed alt text. If it isn't, this will be an empty dict;
    this lets us use the `with` operator even when the trimmed alt text is an
    empty string.
*/}}
{{- $alt := partial $getPrefixTrimmedAltText (dict "Prefixes" $Prefixes "Text" $Text) -}}

{{- with $alt -}}
  {{/*  Retrieve and merge the passed options with the preset options  */}}
  {{- $mergeParams := dict "Attributes"          $Attributes
                           "Destination"         $Destination
                           "Page"                $Page
                           "PresetDotPathPrefix" $PresetDotPathPrefix
                           "PresetKeysToRender"  $PresetKeysToRender
                           "Text"                $alt.Value
                           "TextKey"             $TextKey
                           "Title"               $Title
                           "TitleKey"            $TitleKey
                           "ValidAttributes"     $ValidAttributes
  -}}
  {{- $mergedOptions  := partial $getMergedLinkOptions $mergeParams                  -}}
  {{- $Canonicalizing := dict "Page" $Page "Options" $mergedOptions "Config" $Config -}}
  {{- $Canonicalized  := partial $canonicalize $Canonicalizing                       -}}

  {{/*  Render the image with the template from the canonicalized info  */}}
  {{- $renderedImage = partial $Canonicalized.Template $Canonicalized -}}
{{- end -}}

{{- return $renderedImage -}}
