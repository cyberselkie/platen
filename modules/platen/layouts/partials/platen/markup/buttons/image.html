{{- $Params       := .                                                         -}}
{{- $Page         := $Params.Page                                              -}}
{{- $Destination  := $Params.Destination                                       -}}
{{- $Title        := $Params.Title                                             -}}
{{- $Text         := $Params.Text                                              -}}
{{- $IsBlock      := $Params.IsBlock                                           -}}
{{- $Ordinal      := $Params.Ordinal                                           -}}
{{- $ConfigKey    := "platen.markup.buttons"                                   -}}
{{- $Config       := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}
{{- $Aliases      := $Config.aliases                                           -}}
{{- $PresetPrefix := "preset:"                                                 -}}

{{- $renderedImage := "" -}}

{{- $prefixes := slice "button:" "btn:" -}}
{{- range $alias := $Aliases -}}
  {{- $prefixes = $prefixes | append (printf "%s:" $alias) -}}
{{- end -}}

{{- $hasPrefix := false -}}
{{- $alt       := $Text -}}

{{- range $prefix := $prefixes -}}
  {{- if and (not $hasPrefix) (hasPrefix $Text $prefix) -}}
    {{- $hasPrefix = true                             -}}
    {{- $alt       = strings.TrimPrefix $prefix $Text -}}
  {{- end -}}
{{- end -}}

{{- if $hasPrefix -}}
  {{/* Retrieve the defaults from data, init style and preset opts */}}
  {{- $passedOptions := dict -}}
  {{- $mergedOptions := dict -}}
  {{- $presetOptions := dict -}}

  {{- with $Destination -}}
    {{- if hasPrefix $Destination $PresetPrefix -}}
      {{- $PresetPath   := strings.TrimPrefix $PresetPrefix $Destination    -}}
      {{- $passedOptions = merge $passedOptions (dict "preset" $PresetPath) -}}
    {{- else -}}
      {{- $passedOptions = merge $passedOptions (dict "destination" $Destination) -}}
    {{- end -}}
  {{- end -}}

  {{- with $alt -}}
    {{- $passedOptions = merge $passedOptions (dict "text" $alt) -}}
  {{- end -}}

  {{- if $IsBlock -}}
    {{- $attributes      := $Params.Attributes -}}
    {{- $ValidAttributes := slice "class" "preset" "style" -}}
    {{- range $ValidAttribute := $ValidAttributes -}}
      {{- with (index $attributes $ValidAttribute) -}}
        {{- $passedOptions = merge $passedOptions (dict $ValidAttribute .) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- with $passedOptions.preset -}}
    {{- $presetOptions = partialCached "platen/markup/buttons/_getPreset" . . -}}
  {{- end -}}

  {{- range $PresetKey, $presetValue := $presetOptions -}}
    {{- if eq "text" $PresetKey -}}
      {{- $presetValue = $Page.RenderString $presetValue -}}
    {{- end -}}
    {{- $MergedValue  := index $passedOptions $PresetKey | default $presetValue -}}
    {{- $mergedOptions = merge $mergedOptions (dict $PresetKey $MergedValue)  -}}
  {{- end -}}
  {{- range $PassedKey, $PassedValue := $passedOptions -}}
    {{- with index $mergedOptions $PassedKey -}}
      {{/* Nothing to do, already merged */}}
    {{- else -}}
      {{/* Not defined in preset options, add value from passed options */}}
      {{- $mergedOptions = merge $mergedOptions (dict $PassedKey $PassedValue) -}}
    {{- end -}}
  {{- end -}}

  {{- $Canonicalizing := dict "Page" $Page "Options" $mergedOptions                    -}}
  {{- $Canonicalized  := partial "platen/markup/buttons/_canonicalize" $Canonicalizing -}}

  {{- $renderedImage = partial "platen/markup/buttons/_render" $Canonicalized -}}
{{- end -}}

{{- return $renderedImage -}}
