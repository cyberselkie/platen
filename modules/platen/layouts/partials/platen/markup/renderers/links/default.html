{{- if .Page.Site.Params.Platen.Features.PortableLinks.Enabled -}}
  {{- template "portable-link" . -}}
{{- else -}}
  {{- $href       := printf `href="%s"` (.Destination | safeURL) -}}
  {{- $text       := .Text | safeHTML -}}
  {{- $attributes := slice $href -}}
  {{- with .Title -}}
    {{- $title := printf `title="%s"` . -}}
    {{- $attributes = $attributes | append $title -}}
  {{- end -}}
  {{- $attributes = partial "platen/utils/getSafeAttributes" $attributes -}}
  {{- printf "<a %s>%s</a>" $attributes $text | safeHTML -}}
{{- end -}}

{{- define "portable-link" -}}
  {{- $destination := .Destination }}
  {{- $isRemote    := or (in .Destination ":") (strings.HasPrefix .Destination "//") }}
  {{- if not $isRemote }}
    {{- $url  := urls.Parse .Destination                   }}
    {{- $path := strings.TrimSuffix "/_index.md" $url.Path }}
    {{- $path  = strings.TrimSuffix "/_index"    $path     }}
    {{- $path  = strings.TrimSuffix ".md"        $path     }}
    {{- $page := .Page.GetPage $path                       }}
    {{- if $page }}
      {{- $destination = $page.RelPermalink }}
      {{- if $url.Fragment }}
        {{- $destination = print $destination "#" $url.Fragment }}
      {{- end }}
    {{- else if fileExists (print .Page.File.Dir .Destination) }}
      <!-- Nothing -->
    {{- else -}}
      {{- warnf "Page '%s' not found in '%s'" .Destination .Page.File }}
    {{- end }}
  {{- end }}
  {{- $href       := printf `href="%s"` ($destination | safeURL) -}}
  {{- $text       := .Text | safeHTML -}}
  {{- $attributes := slice $href -}}
  {{- with .Title -}}
    {{- $title := printf `title="%s"` . -}}
    {{- $attributes = $attributes | append $title -}}
  {{- end -}}
  {{- $attributes = partial "platen/utils/getSafeAttributes" $attributes -}}
  {{- printf "<a %s>%s</a>" $attributes $text | safeHTML -}}
{{- end -}}
