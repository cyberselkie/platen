{{- $Params     := .                                   -}}
{{- $Config     := site.Params.platen.markup.columns   -}}
{{- $Aliases    := $Config.aliases                     -}}
{{- $Page       := $Params.Page                        -}}
{{- $Position   := $Params.Position                    -}}
{{- $definition := $Params.Inner                       -}}
{{- $type       := $Params.Type | lower                -}}
{{- $Attributes := $Params.Attributes                  -}}

{{- $renderedCode := "" -}}

{{- $groupLanguageIDs := slice "columns" -}}
{{- $entryLanguageIDs := slice "column"  -}}
{{- with $Aliases -}}
  {{- if reflect.IsMap $Aliases -}}
    {{- $groupAliases := $Aliases.group -}}
    {{- $entryAliases := $Aliases.entry -}}
    {{- with $groupAliases -}}
      {{- if (reflect.IsMap $groupAliases) -}}
        {{- errorf "Invalid definition for platen.markup.columns.aliases.group; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $groupAliases) -}}
        {{- $groupLanguageIDs = union $groupLanguageIDs $groupAliases -}}
      {{- else -}}
        {{- $groupLanguageIDs = $groupLanguageIDs | append (print $groupAliases) -}}
      {{- end  -}}
    {{- end -}}
    {{- with $entryAliases -}}
      {{- if (reflect.IsMap $entryAliases) -}}
        {{- errorf "Invalid definition for platen.markup.columns.aliases.entry; must be one or more strings." -}}
      {{- else if (reflect.IsSlice $entryAliases) -}}
        {{- $entryLanguageIDs = union $entryLanguageIDs $entryAliases -}}
      {{- else -}}
        {{- $entryLanguageIDs = $entryLanguageIDs | append (print $entryAliases) -}}
      {{- end  -}}
    {{- end -}}
  {{- else if (reflect.IsSlice $Aliases) -}}
    {{- $groupLanguageIDs = union $groupLanguageIDs $Aliases -}}
  {{- else -}}
    {{- $groupLanguageIDs = $groupLanguageIDs | append (print $Aliases) -}}
  {{- end  -}}
{{- end -}}

{{- if in $groupLanguageIDs $type -}}
  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams                       -}}

  {{/* Handle attributes and data */}}
  {{- $class     := $info.Data.class | default $Attributes.class -}}
  {{- $id        := $info.Data.id    | default $Attributes.id    -}}
  {{- $group     := printf "%s-%s"     $type $id                 -}}
  {{- $definition = $info.Markdown                               -}}

  {{/* Check for group ID, error if it isn't set */}}
  {{- with $id -}}
  {{- else -}}
    {{- errorf "Missing mandatory ID for columns block at %s" $Position -}}
  {{- end -}}

  {{/* Process the actual definition, error if it's empty */}}
  {{- with $definition -}}
    {{/*
      This matches 3 or more backticks (\x60) followed by any valid column entry language id and
      optionally followed by a single-line attribute list with at least one space before the opening
      curly brace. It then matches all of the text inside the codeblock and the first closing fence.
    */}}
    {{- $findColumnPattern := printf `\x60{3,}(%s)(\s+{(.+)})?(.|\s)+?\x60{3,}`
                                         (delimit $entryLanguageIDs "|")
    -}}

    {{/* Find and munge the definitions for the columns, adding the group ID to their YAML data */}}
    {{- $inputColumns := findRE $findColumnPattern $definition -}}
    {{- range $column := $inputColumns -}}
      {{- $columnLines      := split $column "\n"                                             -}}
      {{- $columnOpen       := index (first 1 $columnLines) 0                                 -}}
      {{- $columnClose      := index (last  1 $columnLines) 0                                 -}}
      {{- $columnLines       = first (sub (len $columnLines) 1) $columnLines                  -}}
      {{- $columnLines       = last  (sub (len $columnLines) 1) $columnLines                  -}}
      {{- $columnDefinition := delimit $columnLines "\n"                                      -}}
      {{- $columnInfoParams := merge $infoParams (dict "Definition" $columnDefinition)        -}}
      {{- $columnInfo       := partial "platen/utils/getCodeblockInfo" $columnInfoParams      -}}
      {{- $columnData       := merge $columnInfo.Data (dict "groupID" $group)                 -}}
      {{- $columnInfo        = merge $columnInfo (dict "Data" $columnData)                    -}}
      {{- $columnDefinition  = partial "platen/utils/getCodeblockFromInfo" $columnInfo        -}}
      {{- $columnDefinition  = printf "%s\n%s\n%s" $columnOpen $columnDefinition $columnClose -}}
      {{- $definition        = replace $definition $column $columnDefinition                  -}}
    {{- else -}}
      {{- errorf "No columns specified in column block at %s" $Position -}}
    {{- end -}}

    {{/* Render the inner markdown for the columns */}}
    {{- $renderedColumns := $definition | $Page.RenderString (dict "display" "block") -}}
    {{- $renderedColumns  = trim $renderedColumns "\n" -}}

    {{/* Define the default classes for the container div. */}}
    {{- $groupClasses := "platen-columns flex flex-wrap" -}}

    {{/* Define the column group attributes */}}
    {{- $groupAttributes := slice (printf `id="%s"` $group) -}}
    {{- with $class -}}
      {{- $groupClasses = printf "%s %s" $groupClasses $class -}}
    {{- end -}}
    {{ $groupAttributes = $groupAttributes
                              | append (printf `class="%s"` $groupClasses)
    -}}
    {{- $attributeParams := dict    "Attributes" $groupAttributes    "IndentCount" 5   -}}
    {{- $groupAttributes  = partial "platen/utils/getSafeAttributes" $attributeParams  -}}

    {{/* Render the column group */}}
    {{- $renderStrings := slice (printf `<div %s>` $groupAttributes) -}}
    {{- $renderStrings  = $renderStrings | append $renderedColumns   -}}
    {{- $renderStrings  = $renderStrings | append `</div>`           -}}
    {{- $renderedCode   = delimit $renderStrings "\n"                -}}
  {{- else -}}
    {{- errorf "No content in definition for columns block at %s" $Position -}}
  {{- end -}}
{{- else if in $entryLanguageIDs $type -}}
  {{/* Parse the definition for data and markdown */}}
  {{- $infoParams := dict "Definition" $definition "SupportsData" true "SupportsMarkdown" true -}}
  {{- $info       := partial "platen/utils/getCodeblockInfo" $infoParams -}}
  {{- $definition  = $info.Markdown -}}

  {{/* Handle attributes and data */}}
  {{- $class   := $info.Data.class | default $Attributes.class                  -}}
  {{- $id      := $info.Data.id    | default $Attributes.id                     -}}
  {{- $grow    := $info.Data.grow  | default $Attributes.grow | default 1 | int -}}
  {{- $groupID := $info.Data.groupID                                            -}}
  {{- with $groupID -}}
  {{- else -}}
    {{- errorf "Missing group ID for column at '%s'. Is it inside a `columns` block?" $Position -}}
  {{- end -}}

  {{/* Define the default classes for the column divs */}}
  {{- $columnClasses := "flex-even markdown-inner" -}}

  {{/* Define attributes for the column */}}
  {{- $columnAttributes := slice (printf `style="flex-grow: %v;"` $grow) -}}
  {{- with $class -}}
    {{- $columnClasses = printf "%s %s" $columnClasses $class -}}
  {{- end -}}
  {{- $columnAttributes = $columnAttributes | append (printf `class="%s"` $columnClasses) -}}
  {{- with $id -}}
    {{- $columnAttributes = $columnAttributes | append (printf `id="%s"` $id) -}}
  {{- end -}}
  {{- $attributeParams := dict    "Attributes" $columnAttributes  "IndentCount" 7   -}}
  {{- $columnAttributes = partial "platen/utils/getSafeAttributes" $attributeParams -}}

  {{/* Get the rendered content */}}
  {{- $renderParams    := dict "Page" $Page "Content" $definition "IndentCount" 4 "AsBlock" true -}}
  {{- $renderedColumn  := partial "platen/utils/getPrettyRender" $renderParams                   -}}

  {{/* Build the rendered code */}}
  {{- $renderStrings := slice (printf `  <div %s>` $columnAttributes)
                              (printf `    %s`     $renderedColumn)
                              "  </div>\n"
  -}}
  {{- $renderedCode = delimit $renderStrings "\n" -}}
{{- end -}}

{{- return $renderedCode -}}
