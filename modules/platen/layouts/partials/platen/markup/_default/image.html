{{- $Context          := . -}}
{{- $UsePortableLinks := partialCached "platen/param/getKey"
                                       "platen.features.portable_links.enabled"
                                       "platen.features.portable_links.enabled"
-}}
{{- if $UsePortableLinks -}}
  {{- template "portable-image" $Context -}}
{{- else -}}
  <img src="{{ $Context.Destination | safeURL }}"
       alt="{{ $Context.Text }}" {{ with $Context.Title }}title="{{ . }}"{{ end }}/>
{{- end -}}

{{- define "portable-image" -}}
  {{- $Context  := . -}}
  {{- $Destination := $Context.Destination -}}
  {{- $File        := $Context.Page.File   -}}
  {{- $isRemote := or (in $Destination "://") (strings.HasPrefix $Destination "//") }}
  {{- if not $isRemote }}
    {{- $path := print $File.Dir $Destination }}
    {{- if strings.HasPrefix $Destination "/" }}
      {{- $path = print "/static" $Destination }}
    {{- end }}
    {{- if not (fileExists $path) }}
      {{- warnf "Image '%s' not found in '%s'" $Destination $File }}
    {{- end }}
  {{- end }}
  <img src="{{ $Destination | safeURL }}"
       alt="{{ $Context.Text }}" {{ with $Context.Title }}title="{{ . }}"{{ end }}/>
{{- end -}}
