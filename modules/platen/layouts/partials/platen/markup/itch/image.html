{{- $Params      := .                                                                -}}
{{- $Page        := $Params.Page                                                     -}}
{{- $destination := $Params.Destination                                              -}}
{{- $title       := $Params.Title                                                    -}}
{{- $text        := $Params.PlainText                                                -}}
{{- $IsBlock     := $Params.IsBlock                                                  -}}
{{- $Ordinal     := $Params.Ordinal                                                  -}}
{{- $ConfigKey   := "platen.markup.itch"                                             -}}
{{- $Config      := partialCached "platen/param/getKey" $ConfigKey $ConfigKey -}}

{{- $renderedImage := "" -}}

{{- $prefixes := slice "itch:" -}}
{{- range $alias := $Config.aliases -}}
  {{- $prefixes = $prefixes | append (printf "%s:" $alias) -}}
{{- end -}}

{{- $hasPrefix := false -}}
{{- $alt       := $text -}}

{{- range $prefix := $prefixes -}}
  {{- if and (not $hasPrefix) (hasPrefix $text $prefix) -}}
    {{- $hasPrefix = true                             -}}
    {{- $alt       = strings.TrimPrefix $prefix $text -}}
  {{- end -}}
{{- end -}}

{{- if $hasPrefix -}}
  {{/* Presets contain settings from site data */}}
  {{- $preset     := dict -}}
  {{/* Retrieve attributes for block syntax image only */}}
  {{- $attributes := dict -}}

  {{/* Initialize iframe attribute list and mandatory values */}}
  {{- $iframeAttributes := slice -}}
  {{- $title            := ""    -}}

  {{/* Set default values */}}
  {{- $height := 167 -}}
  {{- $width  := 552 -}}

  {{/* Set base URL */}}
  {{- $BaseUrl := "https://itch.io/embed" -}}
  {{- $url     := ""                      -}}

  {{- with $destination -}}
    {{- if not (findRE `^\d+$` $destination) -}}
      {{- warnf "Destination is a preset: '%s'" $destination -}}
      {{- with index site.Data.platen.embeds.itch $destination -}}
        {{- $preset = . -}}
        {{- with $preset.id -}}
          {{- $url = printf "%s/%v" $BaseUrl . -}}
        {{- end -}}
      {{- else -}}
        {{- errorf "Unable to find preset '%s' in site data 'platen.embeds.itch' - is '%s.yaml' defined?" -}}
      {{- end -}}
    {{- else -}}
      {{- warnf "Destination is an ID:  '%s'" $destination -}}
      {{- $url = printf "%s/%s" $BaseUrl $destination -}}
    {{- end -}}

    {{/*
      Handle the alt text. If it's provided, use as title for iframe. Otherwise, assume the use of a
      preset which should have a title.
    */}}
    {{- with $alt -}}
      {{- $title = $alt -}}
    {{- else -}}
      {{- with $preset.title -}}
        {{- $title = . -}}
      {{- else -}}
        {{- errorf "Missing title for itch embed; no title specified as alt text or in preset from site data (platen.embeds.itch.%s)." $destination -}}
      {{- end -}}
      {{- warnf "Finding itchio preset %s" $destination -}}
    {{- end -}}

    {{/* If the image is a block, handle the attributes. */}}
    {{/* Both should set the url and title */}}
    {{- if $IsBlock -}}
      {{- $attributes       = $Params.Attributes -}}
      {{- $dark            := $attributes.dark
                              | default $preset.dark
                              | default false
      -}}
      {{- $square          := $attributes.square
                              | default $preset.square
                              | default false
      -}}
      {{- $linkback        := $attributes.linkback
                              | default $preset.linkback
                              | default false
      -}}
      {{- $backgroundColor := $attributes.background_color | default $preset.background_color -}}
      {{- $textColor       := $attributes.text_color       | default $preset.text_color       -}}
      {{- $buttonColor     := $attributes.button_color     | default $preset.button_color     -}}
      {{- $borderColor     := $attributes.border_color     | default $preset.border_color     -}}
      {{- $borderWidth     := $attributes.border_width     | default $preset.border_width     -}}
      {{- $urlQueryParams  := slice                                                           -}}

      {{/* In this case the usage specified a preset that didn't define an id */}}
      {{- if eq $url "" -}}
        {{- with $attributes.id -}}
          {{- $url = printf "%s/%s" $BaseUrl . -}}
        {{- else -}}
          {{- errorf "No ID specified for itch embed. Used preset '%s', which doesn't define an id, without specifying an ID attribute." $destination -}}
        {{- end -}}
      {{- end -}}

      {{- if $linkback -}}
        {{- $urlQueryParams = $urlQueryParams | append "linkback=true" -}}
      {{- end -}}
      {{- if $dark -}}
        {{- $urlQueryParams = $urlQueryParams | append "dark=true" -}}
      {{- end -}}
      {{- if $square -}}
        {{- $width = 208 -}}
      {{- end -}}
      {{- with $backgroundColor -}}
        {{- $backgroundColor = strings.TrimPrefix "#" $backgroundColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `bg_color=%s` $backgroundColor) -}}
      {{- end -}}
      {{- with $textColor -}}
        {{- $textColor      = strings.TrimPrefix "#" $textColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `fg_color=%s` $textColor) -}}
      {{- end -}}
      {{- with $buttonColor -}}
        {{- $buttonColor    = strings.TrimPrefix "#" $buttonColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `link_color=%s` $buttonColor) -}}
      {{- end -}}
      {{- with $borderColor -}}
        {{- $borderColor    = strings.TrimPrefix "#" $borderColor -}}
        {{- $urlQueryParams = $urlQueryParams | append (printf `border_color=%s` $borderColor) -}}
      {{- end -}}
      {{- with $borderWidth -}}
        {{- $borderWidth = int $borderWidth -}}
        {{- if and (ge $borderWidth 0) (le $borderWidth 5) -}}
          {{- $urlQueryParams = $urlQueryParams | append (printf `border_width=%v` $borderWidth) -}}
        {{- else -}}
          {{- errorf "%s" (i18n "ErrorItchioInvalidBorderWidth" (print $borderWidth)) -}}
        {{- end -}}
      {{- end -}}
      {{- $urlQueryParams = delimit $urlQueryParams "&" -}}

      {{/* Add the query parameters to the url, if any */}}
      {{- with $urlQueryParams -}}
        {{- $url = printf "%s?%s" $url $urlQueryParams -}}
      {{- end -}}
    {{- end -}}

    {{- $iframeAttributes = $iframeAttributes | append (printf `src="%s"` $url) -}}

    {{- with $title -}}
        {{- $iframeAttributes = $iframeAttributes | append (printf `title="%s"` $title) -}}
    {{- else -}}
      {{- $message := i18n "ErrorItchioMissingTitle"}}
      {{- warnf "%s" $message -}}
    {{- end -}}

    {{- $iframeAttributes = $iframeAttributes | append `frameborder="0"`              -}}
    {{- $iframeAttributes = $iframeAttributes | append (printf `height="%v"` $height) -}}
    {{- $iframeAttributes = $iframeAttributes | append (printf `width="%v"`  $width)  -}}

    {{- $attributeParams := dict "Attributes" $iframeAttributes "IndentCount" 8       -}}
    {{- $attributes       = partial "platen/utils/getSafeAttributes" $attributeParams -}}
    {{- $renderedImage    = printf "<iframe %s></iframe>" $attributes                 -}}
  {{- else -}}
    {{- errorf (i18n "ErrorItchioMissingID" (dict "page" $Page)) -}}
  {{- end -}}
{{- end -}}

{{- return $renderedImage -}}
