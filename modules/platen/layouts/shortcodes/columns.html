{{/*
    Docs.ShortCode: columns

    This shortcode can be used to turn markdown content into columns with a
    flexible ratio.
    It has two optional parameters, `ratio` and `flattenForMobile`. They can
    be specified by name or position. For example, these two shortcodes have the
    same functionality:
      {{< columns ratio="3:7" flattenForMobile=false >}}
      {{< columns "3:7" false >}}
    Note that to specify `flattenForMobile` but not `ratio` without using
    named parameters, you **must** specify the ratio as an empty string:
      {{< columns "" false >}}
    
    The `ratio` parameter should be specified as a string of integers separated
    by colons (`:`), such as `1:2:1` or `1:1:3:1`. If `ratio` is not specified
    (or is set to an empty string, `""`), the columns are evenly distributed.
    For more information on flexible columns, see the docs on MDN:
    https://developer.mozilla.org/en-US/docs/Web/CSS/flex-grow
    
    If `flattenForMobile` is specified as `true`, the `flatten-in-mobile`
    class is added to the container for the columns. This causes the columns to
    collapse into a vertical stack when in mobile view to help make them more
    readable on smaller screens. If `flattenForMobile` is not specified,
    the columns will still display horizontally, even on smaller screens.
*/}}

{{- $input             := .                                                      -}}

{{/* Process input parameters */}}
{{- $ratio             := default ($input.Get 0) ($input.Get "Ratio")            -}}
{{- $ratio              = default ""             $ratio                          -}}
{{- $flattenForMobile  := default ($input.Get 1) ($input.Get "flattenForMobile") -}}
{{- $columns           := split   $input.Inner   "<--->"                         -}}

{{/*
  Handle mobile flattening. If not using named params, specifying either boolean true or the string
  `flattenForMobile` adds the behavior. Boolean false, `nil`, and any other string value does not.
*/}}
{{- if not $input.IsNamedParams -}}
  {{- $flattenForMobile = or (eq true               $flattenForMobile)
                             (eq "flattenForMobile" $flattenForMobile)
  -}}
{{- end -}}

{{/*
  Handle ratio declarations. If ratio is specified but the segment count isn't the same as the
  column count, raise an error. After this handling, ratio is replaced with the slice of ratios
  by splitting on the colon in the input string. If no colon is included, ratio is set to an empty
  string instead.
*/}}
{{- with $ratio -}}
  {{- if strings.Contains $ratio ":" -}}
    {{- $ratioSlice  := split . ":"     -}}
    {{- $ratioCount  := len $ratioSlice -}}
    {{- $columnCount := len $columns    -}}
    {{- if ne $ratioCount $columnCount -}}
      {{- $message := printf "Invalid ratio for %s at %s" $input.Name $input.Position -}}
      {{- $message  = printf "%s\n\tSpecified ratio %s has %v segments but there are %v columns."
                             $message $ratio $ratioCount $columnCount
      -}}
      {{- $message  = printf "%s The number of ratio segments must match the number of columns."
                             $message
      -}}
      {{- errorf $message -}}
    {{- else -}}
      {{- $ratio = $ratioSlice -}}
    {{- end -}}
  {{- else -}}
    {{- $ratio = "" -}}
  {{- end -}}
{{- end -}}

{{/* Define the default classes for the container div and the column divs. */}}
{{- $containerClasses := "platen-columns flex flex-wrap" -}}
{{- $columnClasses    := "flex-even markdown-inner"      -}}
{{- if $flattenForMobile -}}
  {{- $containerClasses = printf "%s flatten-in-mobile" $containerClasses -}}
{{- end -}}

{{/*
  Process the columns for rendering, defining their attributes. This creates a slice of dictionaries
  with the Attribute and Content keys defined. The attribute key holds the class attribute and, if
  using ratios, the style attribute. It combines them into a single string and makes them insertable
  as HTML attributes later, associated with their column's content.
*/}}
{{- $columnsToRender := slice -}}
{{- range $columnIndex, $columnContent := $columns -}}
  {{- $attributes := slice (printf `class="%s"` $columnClasses) -}}
  {{- if $ratio -}}
    {{- $columnRatio := index $ratio $columnIndex                                           -}}
    {{- $attributes   = $attributes | append (printf `style="flex-grow: %s;"` $columnRatio) -}}
  {{- end -}}
  {{- $attributes      = partial "platen/utils/getSafeAttributes" $attributes   -}}
  {{- $columnParams   := dict "Attributes" $attributes "Content" $columnContent -}}
  {{- $columnsToRender = $columnsToRender | append $columnParams                -}}
{{- end -}}

{{/* Render the column container and each column in turn. */}}
<div class="{{ $containerClasses }}">
  {{- range $column := $columnsToRender }}
  <div {{ $column.Attributes }}>
    {{ $column.Content | $.Page.RenderString }}
  </div>
  {{ end }}
</div>
